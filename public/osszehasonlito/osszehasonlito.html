<!DOCTYPE html>
<html lang="hu">
	<head>
		<title>Összehasonlító - Hausz</title>
		<meta charset="UTF-8">
        <meta name="description" content="Fájl összehasonlító szolgáltatás.">
		<link rel="stylesheet" type="text/css" href="/index/alapok.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="shortcut icon" type="image/png" href="/index/favicon.png"/>
	</head>
	<body>
        <h1 class="kozepre-szoveg">Összehasonlító</h1>
        <div class="kozepre" style="max-width: 800px; width: 90%">
            <h2 id="instruction">Csatolj két fájlt a kezdéshez</h2>
            <div>
                <table>
                    <tr>
                        <td>
                            <div class="file-box">
                                <label id="file1-label" for="file1">Fájl 1</label>
                                <input type="file" id="file1" name="file1" onchange="fileChanged(1)" />
                                <div id="file1-preview">
                                    <img style="display: none" src="" id="file1-preview-img" />
                                    <video style="display: none" controls id="file1-preview-video">
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video element.
                                    </video>
                                    <pre style="display: none" id="file1-preview-text"></pre>
                                </div>
                                <div id="sliderDiv2" style="visibility: hidden;">
                                    <input id="volumeSlider1" style="width: 100%" type="range" min="0" max="1" step="0.01" value="1" oninput="volumeChanged(1)" />
                                    <br>
                                    <div id="volumeSlider1Text">100%</div>
                                </div>

                            </div>
                        </td>
                        <td>
                            <div class="file-box">
                                <label id="file2-label" for="file2">Fájl 2</label>
                                <input type="file" id="file2" name="file2" onchange="fileChanged(2)" />
                                <div id="file2-preview">
                                    <img style="display: none" src="" id="file2-preview-img" />
                                    <video style="display: none" controls id="file2-preview-video">
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video element.
                                    </video>
                                    <pre style="display: none" id="file2-preview-text"></pre>
                                </div>
                                <div id="sliderDiv1" style="visibility: hidden;">
                                    <input id="volumeSlider2" style="width: 100%" type="range" min="0" max="1" step="0.01" value="1" oninput="volumeChanged(2)" />
                                    <br>
                                    <div id="volumeSlider2Text">100%</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                        </td>
                        <td>
                        </td>
                    </tr>
                </table>

                <div id="unifiedControls" style="visibility: hidden;">
                    <div id="progressBar" onclick="progressBarClicked(event)" style="visibility: hidden; background-color: rgb(128,128,128)">
                        <div id="progressBarInner" style="visibility: hidden; background-color: red; height: 20px"></div>
                    </div>
                    <button id="pausePlay" onclick="pausePlay()">Pause / Play</button>
                    <button id="switchInputs" onclick="switchInputs()">Switch input</button>
                    <button id="reset" onclick="reset()">Reset</button>
                </div>
            </div>
            <br><br><br><br><br>
        </div>

        <script>
            let currentlySelectedInput = 1;
            let previewType = "";
            let audio1 = new Audio();
            let audio2 = new Audio();
            let audioShortestSeconds = 0;
            let progressBar;
            let progressBarInner;

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            var audioCtx = new AudioContext();
            let gain1 = audioCtx.createGain();
            let gain2 = audioCtx.createGain();

            let volume1;
            let volume2;

            let source1;
            let source2;

            window.onload = function() {
                volume1 = localStorage.getItem("volume1");
                volume2 = localStorage.getItem("volume2");

                if (volume1 == null) {
                    volume1 = 1;
                }

                if (volume2 == null) {
                    volume2 = 1;
                }

                obj("volumeSlider1").value = volume1;
                obj("volumeSlider2").value = volume2;

                obj("volumeSlider1Text").innerHTML = Math.round(volume1 * 100) + "%";
                obj("volumeSlider2Text").innerHTML = Math.round(volume2 * 100) + "%";
            }

            function obj(element_name) {
                return document.getElementById(element_name);
            }

            function progressBarClicked(event) {
                if (previewType == "text") {
                    return;
                }
                
                let shorterTrack = audio1.duration < audio2.duration ? audio1 : audio2;
                let clickedPercentage = event.offsetX / progressBar.offsetWidth;
                let shorterTrackClickedTime = shorterTrack.duration * clickedPercentage;
                audio1.pause();
                audio2.pause();

                audio1.currentTime = shorterTrackClickedTime;
                audio2.currentTime = shorterTrackClickedTime;

                setTimeout(function() {
                    audio1.play();
                    audio2.play();
                }, 250);
            }

            function fileChanged(number) {
                var file = obj("file" + number).files[0];
                var fileExtension = file.name.split('.').pop().toLowerCase();
                var textExtensions = ['txt', 'html'];
                var audioExtensions = ['mp3', 'flac', 'wav', 'ogg'];
                var videoExtensions = ['mp4', 'webm'];
                var imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'];
                var allowedExtensions = textExtensions.concat(audioExtensions, videoExtensions, imageExtensions);

                if (!allowedExtensions.includes(fileExtension)) {
                    alert("A fájl kiterjesztése nem támogatott az összehasonlításhoz!");
                    obj("file" + number).value = "";
                    return;
                }

                obj("file" + number + "-preview-text").style.display = "none";
                obj("file" + number + "-preview-video").style.display = "none";
                obj("file" + number + "-preview-img").style.display = "none";

                if (textExtensions.includes(fileExtension)) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        obj("file" + number + "-preview-text").innerHTML = reader.result;
                    }
                    reader.readAsText(file);
                    obj("file" + number + "-preview-text").style.display = "block";
                    previewType = "text";
                }

                if (audioExtensions.includes(fileExtension)) {
                    if(number == 1) {
                        audio1.src = URL.createObjectURL(file);
                        audio1.controls = true;
                        audio1.autoplay = false;
                        audio1.preload = "auto";
                        audio1.muted = false;
                        
                        source1 = audioCtx.createMediaElementSource(audio1);
                        audio1.load();
                    }
                    if(number == 2) {
                        audio2.src = URL.createObjectURL(file);
                        audio2.controls = true;
                        audio2.autoplay = false;
                        audio2.preload = "auto";
                        audio2.muted = false;
                        
                        source2 = audioCtx.createMediaElementSource(audio2);
                        audio2.load();
                    }

                    gain1.gain.value = currentlySelectedInput == 1 ? 1.0 : 0.0;
                    gain2.gain.value = currentlySelectedInput == 2 ? 1.0 : 0.0;

                    previewType = "audio";
                }

                if (videoExtensions.includes(fileExtension)) {
                    obj("file" + number + "-preview-video").src = URL.createObjectURL(file);
                    obj("file" + number + "-preview-video").style.display = "block";
                    previewType = "video";
                }

                if (imageExtensions.includes(fileExtension)) {
                    obj("file" + number + "-preview-img").src = URL.createObjectURL(file);
                    obj("file" + number + "-preview-img").style.display = "block";
                    previewType = "image";
                }

                if (obj("file1").value != "" && obj("file2").value != "") {
                    bothReady();
                }
            }

            function bothReady() {
                obj("file1-preview").style.float = "left";
                obj("file2-preview").style.float = "left";
                obj("unifiedControls").style.display = "block";

                progressBar = obj("progressBar");
                progressBarInner = obj("progressBarInner");

                progressBar.style.visibility = "visible";
                progressBarInner.style.visibility = "visible";

                
                setInterval(function() {
                    if (previewType == "audio") {
                        if( audioShortestSeconds == 0 || isNaN(audioShortestSeconds) ) {
                            audioShortestSeconds = audio1.duration < audio2.duration ? audio1.duration : audio2.duration;
                            return;
                        }

                        let percentage = audio1.currentTime / audioShortestSeconds;
                        progressBarInner.style.width = percentage * 100 + "%";

                        if( audio1.currentTime >= audioShortestSeconds || audio2.currentTime >= audioShortestSeconds ) {
                            audio1.currentTime = 0;
                            audio2.currentTime = 0;
                            audio1.play();
                            audio2.play();
                        }
                    }

                    if (previewType == "video") {
                        let percentage = obj("file1-preview-video").currentTime / obj("file1-preview-video").duration;
                        progressBarInner.style.width = percentage * 100 + "%";
                    }
                }, 33);

                obj("file1").style.display = "none";
                obj("file2").style.display = "none";

                obj("file1-label").innerHTML = obj("file1").files[0].name;
                obj("file2-label").innerHTML = obj("file2").files[0].name;

                obj("file1-label").style.color = currentlySelectedInput == 1 ? "#00ff00" : "#ffffff";
                obj("file2-label").style.color = currentlySelectedInput == 2 ? "#00ff00" : "#ffffff";

                obj("unifiedControls").style.visibility = "visible";

                if( previewType == "audio" ) {
                    obj("instruction").innerHTML = "Listen to the files";
                }

                if( previewType == "image" || previewType == "video" || previewType == "text" ) {
                    obj("instruction").innerHTML = "Watch the files";
                }

                source1.connect(gain1);
                source2.connect(gain2);

                gain1.connect(audioCtx.destination);
                gain2.connect(audioCtx.destination);

                obj("sliderDiv1").style.visibility = "visible";
                obj("sliderDiv2").style.visibility = "visible";

                volume1 = obj("volumeSlider1").value;
                volume2 = obj("volumeSlider2").value;
            }

            function volumeChanged(number) {
                volume1 = number == 1 ? obj("volumeSlider1").value : volume1;
                volume2 = number == 2 ? obj("volumeSlider2").value : volume2;

                gain1.gain.value = currentlySelectedInput == 1 ? volume1 : 0.0;
                gain2.gain.value = currentlySelectedInput == 2 ? volume2 : 0.0;

                obj("volumeSlider" + number + "Text").innerHTML = (number == 1 ? parseInt(volume1 * 100) : parseInt(volume2 * 100)) + "%";

                localStorage.setItem("volume" + number, number == 1 ? volume1 : volume2);
            }

            function pausePlay() {
                if (previewType == "audio") {
                    if( audio1.paused || audio2.paused ) {
                        sync();
                        setTimeout(function() {
                            audio1.play();
                            audio2.play();
                        }, 250);
                    } else {
                        audio1.pause();
                        audio2.pause();
                        setTimeout(function() {
                            sync();
                        }, 250);
                    }

                    obj("pausePlay").innerHTML = audio1.paused || audio2.paused ? "▶️" : "⏸️";
                }

                if (previewType == "video") {
                    if (obj("file1-preview-video").paused == false) {
                        obj("file1-preview-video").pause();
                        obj("file2-preview-video").pause();
                    } else {
                        obj("file" + currentlySelectedInput + "-preview-video").play();
                    }
                }

                updateLabel();
            }

            function switchInputs() {
                currentlySelectedInput = currentlySelectedInput == 1 ? 2 : 1;

                if (previewType == "audio") {
                    gain1.gain.value = currentlySelectedInput == 1 ? volume1 : 0.0;
                    gain2.gain.value = currentlySelectedInput == 2 ? volume2 : 0.0;
                }

                updateLabel();
            }

            function updateLabel() {
                if (previewType == "audio") {
                    obj("file1-label").style.color = currentlySelectedInput == 1 ? "#00ff00" : "#ffffff";
                    obj("file2-label").style.color = currentlySelectedInput == 2 ? "#00ff00" : "#ffffff";
                }
            } 

            function sync() {
                if (previewType == "audio") {
                    if( currentlySelectedInput == 1 ) {
                        audio2.currentTime = audio1.currentTime;
                    } else {
                        audio1.currentTime = audio2.currentTime;
                    }
                }
            }

            function reset() {
                location.reload();
            }

            document.addEventListener('keydown', function(event) {
                Billentyukod_Space = 32;
                Billentyukod_Jobbra = 39;
                Billentyukod_Balra = 37;
                Billentyukod_Fel = 38;
                Billentyukod_Le = 40;

                if (event.keyCode == Billentyukod_Space) {
                    pausePlay();
                }
                
                if (event.keyCode == 37) {
                    if (previewType == "audio") {
                        audio1.currentTime -= 0.1;
                        audio2.currentTime -= 0.1;
                    }

                    if (previewType == "video") {
                        obj("file1-preview-video").currentTime -= 5;
                        obj("file2-preview-video").currentTime -= 5;
                    }
                }

                if (event.keyCode == Billentyukod_Jobbra) {
                    if (previewType == "audio") {
                        audio1.currentTime += 0.1;
                        audio2.currentTime += 0.1;
                    }

                    if (previewType == "video") {
                        obj("file1-preview-video").currentTime += 5;
                        obj("file2-preview-video").currentTime += 5;
                    }
                }

                if (event.keyCode == Billentyukod_Fel) {
                    if (previewType == "audio") {
                        if(currentlySelectedInput == 1) {
                            obj("volumeSlider1").value = obj("volumeSlider1").value + 0.05;
                        } else {
                            obj("volumeSlider2").value = obj("volumeSlider2").value + 0.05;
                        }
                        volumeChanged(currentlySelectedInput);
                    }
                }

                if (event.keyCode == Billentyukod_Le) {
                    if (previewType == "audio") {
                        if(currentlySelectedInput == 1) {
                            obj("volumeSlider1").value = obj("volumeSlider1").value - 0.05;
                        } else {
                            obj("volumeSlider2").value = obj("volumeSlider2").value - 0.05;
                        }
                        volumeChanged(currentlySelectedInput);
                    }
                }
            });
        </script>
	</body>
</html>